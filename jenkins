pipeline {
  agent any
 
  options {
        timeout(time: 1, unit: 'HOURS')
    }
 
  stages {
    stage('Source') {
      steps {
        echo 'Pulling from GitHub'
      }
    }
   
    stage('Build') {
      steps {
        echo '********STARTING BUILD STAGE*******'
        echo '***********************************'
        sh '''
        docker rmi mdmohiuddin/auth:01 mdmohiuddin/user:01 mdmohiuddin/task:01 mdmohiuddin/attendance:01 mdmohiuddin/delivery:01 mdmohiuddin/admin:01
        cd auth
        docker build -t mdmohiuddin/auth:01 .
        cd ../user
        docker build -t mdmohiuddin/user:01 .
        cd ../task
        docker build -t mdmohiuddin/task:01 .
        cd ../attendance
        docker build -t mdmohiuddin/attendance:01 .
        cd ../delivery
        docker build -t mdmohiuddin/delivery:01 .
        cd ../admin
        docker build -t mdmohiuddin/admin:01 .
        '''
        echo '***** DOCKER HUB *****'
        withCredentials([usernamePassword(credentialsId: 'DHC', passwordVariable: 'DHPASS', usernameVariable: 'DHUSER')]) {
          sh "docker login -u ${DHUSER} -p ${DHPASS}"
        }
        echo '***** PUSHING IMAGES TO DOCKER HUB *****'
        sh '''
        docker push mdmohiuddin/auth:01
        docker push mdmohiuddin/user:01
        docker push mdmohiuddin/task:01
        docker push mdmohiuddin/attendance:01
        docker push mdmohiuddin/delivery:01
        docker push mdmohiuddin/admin:01
        '''
      }
    }
   
    stage('Deploy_To_TestServer') {
      steps {
        echo '***** DEPLOYING TO TEST SERVER *****'
            {
          sh "sshpass -p ${TSP} ssh -o StrictHostKeyChecking=no ubuntu@52.91.110.165 'docker-compose down && docker-compose up -d'"
        }
        echo '***** DEPLOYMENT IS DONE FOR TEST SERVER *****'
      }
    }
